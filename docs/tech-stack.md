# LegalSathi Technical Documentation

## Tech Stack Overview

### Frontend
- **Framework**: Next.js 14.1.0 (App Router + Pages Router hybrid)
- **UI Library**: React 18.2.0
- **Styling**: Tailwind CSS 3.4.1 with custom configuration
- **Component Library**: Custom components built on Radix UI primitives
- **State Management**: React Context API + Server Components
- **Animations**: CSS animations, Tailwind animations, Three.js for 3D elements
- **Icons**: Lucide React

### Backend
- **API Routes**: Next.js API Routes (Pages Router) and Route Handlers (App Router)
- **Database**: PostgreSQL (via Supabase)
- **Authentication**: Supabase Auth
- **File Storage**: Supabase Storage
- **Realtime**: Supabase Realtime for live updates

### Infrastructure
- **Hosting**: Vercel
- **Database Hosting**: Supabase
- **CI/CD**: Vercel's GitHub integration
- **Environment Variables**: Vercel Environment Variables

## Architecture

### Application Structure

LegalSathi follows a hybrid architecture using both Next.js App Router and Pages Router:

\`\`\`
legalsathi/
├── app/                  # App Router pages and layouts
│   ├── api/              # API route handlers
│   ├── dashboard/        # Dashboard pages
│   ├── lawyers/          # Lawyer listing pages
│   ├── community/        # Community pages
│   ├── layout.tsx        # Root layout
│   └── page.tsx          # Home page
├── components/           # Shared React components
│   ├── auth/             # Authentication components
│   ├── chat/             # Chat components
│   ├── community/        # Community components
│   ├── dashboard/        # Dashboard components
│   ├── hero/             # Hero section components
│   ├── home/             # Home page components
│   ├── layout/           # Layout components (navbar, footer)
│   ├── lawyers/          # Lawyer components
│   ├── news/             # News components
│   ├── posts/            # Post components
│   ├── profile/          # Profile components
│   └── ui/               # UI components
├── lib/                  # Shared utilities and services
│   ├── context/          # React context providers
│   ├── hooks/            # Custom React hooks
│   ├── services/         # Service modules
│   ├── supabase/         # Supabase client utilities
│   ├── templates/        # Document templates
│   ├── types/            # TypeScript type definitions
│   └── utils/            # Utility functions
├── pages/                # Pages Router (legacy)
│   └── api/              # API routes
├── public/               # Static assets
├── scripts/              # Build and maintenance scripts
└── middleware.ts         # Next.js middleware
\`\`\`

### Data Flow

1. **Server Components** - Fetch data directly from Supabase on the server
2. **Client Components** - Use React hooks to fetch data from API routes
3. **API Routes** - Handle client-side data fetching and mutations
4. **Server Actions** - Handle form submissions and data mutations
5. **Realtime Subscriptions** - Listen for database changes and update UI

## Database Schema

### Core Tables

1. **users** - User accounts and profile information
   - Linked to auth.users via user_id
   - Contains basic profile information

2. **lawyer_profiles** - Extended profiles for lawyer users
   - Linked to users via user_id
   - Contains lawyer-specific information

3. **posts** - Community posts and discussions
   - Linked to users via user_id
   - Contains post content and metadata

4. **comments** - Comments on posts
   - Linked to posts via post_id
   - Linked to users via user_id

5. **cases** - Legal cases posted by clients
   - Linked to users via user_id
   - Contains case details and requirements

6. **applications** - Lawyer applications to cases
   - Linked to cases via case_id
   - Linked to users (lawyers) via user_id

7. **messages** - Direct messages between users
   - Linked to sender and receiver via user_id
   - Contains message content and metadata

8. **documents** - Legal documents generated by users
   - Linked to users via user_id
   - Contains document content and metadata

9. **notifications** - User notifications
   - Linked to users via user_id
   - Contains notification content and metadata

### Row Level Security (RLS)

All tables implement Row Level Security policies to ensure data access is properly controlled:

- Public data (lawyer profiles, public posts) - Viewable by everyone
- Private data (messages, cases) - Only accessible to the owner or involved parties
- User data - Only modifiable by the owner

## Authentication Flow

LegalSathi uses Supabase Authentication with the following flow:

1. **Registration**:
   - User enters email, password, and selects role (client or lawyer)
   - Account is created in Supabase Auth
   - Profile record is created in the users table
   - For lawyers, a lawyer_profile record is created

2. **Login**:
   - User enters credentials
   - Supabase validates and returns JWT tokens
   - Tokens are stored in cookies
   - User is redirected to dashboard

3. **Session Management**:
   - Middleware checks for valid session on protected routes
   - Tokens are automatically refreshed
   - Error handling for token expiration and refresh failures

4. **Social Authentication**:
   - Support for Google and GitHub login
   - OAuth flow handled by Supabase
   - Profile data synchronized with users table

## Key Features

### 1. Lawyer Directory
- Search and filter lawyers by specialization, location, and rating
- View detailed lawyer profiles with experience, education, and reviews
- Contact lawyers directly through the platform

### 2. Case Management
- Clients can post legal cases with detailed requirements
- Lawyers can browse and apply to cases
- Clients can review applications and select lawyers

### 3. Community Forum
- Users can create posts to discuss legal topics
- Support for comments, likes, and filtering
- Real-time updates for new posts and comments

### 4. Document Generation
- Templates for common legal documents (NDA, employment agreements, etc.)
- Custom fields for personalization
- PDF export functionality

### 5. Messaging System
- Direct messaging between clients and lawyers
- Real-time message delivery
- Notification system for new messages

### 6. AI Legal Assistant
- Botpress-powered chatbot for legal guidance
- Accessible throughout the platform
- Provides general legal information and guidance

## Development Workflow

### Local Development

1. Clone the repository
2. Install dependencies with `pnpm install`
3. Set up environment variables (see `.env.local.example`)
4. Run the development server with `pnpm dev`
5. Access the application at `http://localhost:3000`

### Database Migrations

- SQL migrations are stored in the project root
- Migrations can be run manually through the Supabase dashboard
- Critical migrations are documented in the codebase

### Deployment

- The application is deployed on Vercel
- Database is hosted on Supabase
- Deployments are triggered automatically on pushes to the main branch
- Environment variables are configured in the Vercel dashboard

## Performance Optimizations

1. **Server Components** - Reduce client-side JavaScript
2. **Image Optimization** - Next.js Image component for optimized images
3. **Code Splitting** - Automatic code splitting by Next.js
4. **Incremental Static Regeneration** - For semi-static pages
5. **Edge Middleware** - For authentication and redirects

## Security Considerations

1. **Authentication** - Secure JWT-based authentication via Supabase
2. **Row Level Security** - Database-level access control
3. **CSRF Protection** - Built into Next.js API routes
4. **Content Security Policy** - Configured for production
5. **Input Validation** - Server-side validation for all inputs

## Challenges and Solutions

### 1. Hybrid Routing System
- **Challenge**: Supporting both App Router and Pages Router
- **Solution**: Created compatibility layers for auth, data fetching, and headers

### 2. Real-time Updates
- **Challenge**: Ensuring UI reflects database changes immediately
- **Solution**: Implemented Supabase Realtime subscriptions with React context

### 3. Authentication Edge Cases
- **Challenge**: Handling token refresh errors and session expiration
- **Solution**: Added robust error handling and automatic redirects

### 4. Mobile Responsiveness
- **Challenge**: Creating a seamless experience across devices
- **Solution**: Implemented responsive design with Tailwind and custom hooks

## Future Improvements

1. **Full Migration to App Router** - Complete the transition from Pages Router
2. **Enhanced AI Features** - Expand the capabilities of the legal assistant
3. **Payment Integration** - Add payment processing for legal services
4. **Document Collaboration** - Real-time collaborative editing of legal documents
5. **Video Consultations** - Integrated video calling for remote consultations
